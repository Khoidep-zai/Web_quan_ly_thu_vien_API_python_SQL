{% extends 'base.html' %}
{% block title %}Dashboard - Admin{% endblock %}
{% block content %}
<h2 class="mb-4"><i class="bi bi-speedometer2"></i> Dashboard Quản trị</h2>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card stat-card">
      <div class="card-body">
        <h5 class="card-title">Tổng số sách</h5>
        <h2 class="text-primary">{{ total_books }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stat-card success">
      <div class="card-body">
        <h5 class="card-title">Tổng số độc giả</h5>
        <h2 class="text-success">{{ total_users }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stat-card warning">
      <div class="card-body">
        <h5 class="card-title">Sách đang mượn</h5>
        <h2 class="text-warning">{{ total_borrows }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stat-card danger">
      <div class="card-body">
        <h5 class="card-title">Sách quá hạn</h5>
        <h2 class="text-danger">{{ overdue_books }}</h2>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-trophy"></i> Top 10 sách mượn nhiều nhất</h5>
        <a href="{{ url_for('reports.statistics_report') }}" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-file-pdf"></i> PDF
        </a>
      </div>
      <div class="card-body">
        {% if popular_books %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>STT</th>
                  <th>Tên sách</th>
                  <th>Tác giả</th>
                  <th>Số lần mượn</th>
                </tr>
              </thead>
              <tbody>
                {% for book, count in popular_books %}
                  <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ book.title }}</td>
                    <td>{{ book.author or 'N/A' }}</td>
                    <td><span class="badge bg-primary">{{ count }}</span></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">Chưa có dữ liệu</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-people"></i> Top 10 độc giả tích cực</h5>
        <a href="{{ url_for('reports.statistics_report') }}" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-file-pdf"></i> PDF
        </a>
      </div>
      <div class="card-body">
        {% if active_readers %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>STT</th>
                  <th>Tên độc giả</th>
                  <th>Email</th>
                  <th>Số lần mượn</th>
                </tr>
              </thead>
              <tbody>
                {% for user, count in active_readers %}
                  <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ user.name or '-' }}</td>
                    <td>{{ user.email }}</td>
                    <td><span class="badge bg-success">{{ count }}</span></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">Chưa có dữ liệu</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12 mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Sách quá hạn</h5>
        <a href="{{ url_for('loans.all_loans', status='overdue') }}" class="btn btn-sm btn-outline-danger">
          Xem tất cả
        </a>
      </div>
      <div class="card-body">
        {% if overdue_records %}
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Độc giả</th>
                  <th>Tên sách</th>
                  <th>Ngày mượn</th>
                  <th>Hạn trả</th>
                  <th>Số ngày quá hạn</th>
                  <th>Phí trễ hạn</th>
                </tr>
              </thead>
              <tbody>
                {% for record in overdue_records %}
                  <tr class="table-danger">
                    <td>{{ record.user.name or record.user.email }}</td>
                    <td>{{ record.book.title }}</td>
                    <td>{{ record.borrowed_at.strftime('%d/%m/%Y') }}</td>
                    <td>{{ record.due_date.strftime('%d/%m/%Y') }}</td>
                    <td>
                      <span class="badge bg-danger">
                        {{ ((today - record.due_date).days) }} ngày
                      </span>
                    </td>
                    <td>
                      <strong class="text-danger">{{ "{:,.0f}".format(record.calculate_fine()) }} VNĐ</strong>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">Không có sách quá hạn</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Thống kê mượn sách theo tháng (7 tháng gần nhất)</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Tháng</th>
                <th>Số lần mượn</th>
                <th>Biểu đồ</th>
              </tr>
            </thead>
            <tbody>
              {% for stat in months_stats %}
                <tr>
                  <td>{{ stat.month }}</td>
                  <td><strong>{{ stat.count }}</strong></td>
                  <td>
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar" role="progressbar" 
                           style="width: {{ (stat.count / (months_stats|map(attribute='count')|max or 1)) * 100 }}%"
                           aria-valuenow="{{ stat.count }}" aria-valuemin="0" 
                           aria-valuemax="{{ months_stats|map(attribute='count')|max or 1 }}">
                      </div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

